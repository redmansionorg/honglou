import { createClient } from 'npm:@base44/sdk@0.1.0';

// 这个ABI只包含我们需要的 `totalChapters` 函数，更轻量
const MINIMAL_LITERATURE_OPUS_ABI = [
  {
    "inputs": [],
    "name": "totalChapters",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  }
];

Deno.serve(async (req) => {
    try {
        const { novel_id } = await req.json();
        if (!novel_id) throw new Error("novel_id is required");

        const authHeader = req.headers.get('Authorization');
        if (!authHeader) return new Response(JSON.stringify({ error: "Unauthorized" }), { status: 401 });

        const base44 = createClient({ appId: Deno.env.get('BASE44_APP_ID') });
        base44.auth.setToken(authHeader.split(' ')[1]);
        await base44.auth.me();

        const { ethers } = await import('npm:ethers@6.7.1');
        
        const rpcUrl = Deno.env.get("SEPOLIA_RPC_URL");
        if (!rpcUrl) {
            throw new Error("Missing environment variable: SEPOLIA_RPC_URL");
        }

        const novel = await base44.entities.Novel.get(novel_id);
        if (!novel || !novel.bc_contract_address) {
            throw new Error("Novel or its contract address not found.");
        }

        const provider = new ethers.JsonRpcProvider(rpcUrl);
        const novelContract = new ethers.Contract(novel.bc_contract_address, MINIMAL_LITERATURE_OPUS_ABI, provider);

        const totalChapters = await novelContract.totalChapters();
        const totalChaptersNumber = parseInt(totalChapters.toString());
        
        return new Response(JSON.stringify({ 
            success: true,
            novel_id: novel.id,
            count: totalChaptersNumber 
        }), {
            headers: { "Content-Type": "application/json" },
        });

    } catch (error) {
        console.error('Get chapter count error:', error);
        return new Response(JSON.stringify({ 
            error: error.message, 
            details: "An error occurred while fetching chapter count."
        }), {
            status: 500,
            headers: { "Content-Type": "application/json" },
        });
    }
});